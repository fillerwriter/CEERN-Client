<?php

define('CEEN_MAPPING_INCOMING', 'incoming');

define('CEEN_MAPPING_OUTGOING', 'outgoing');

define('CEENCLIENT_FROM_API', 'from api');

define('CEENCLIENT_FROM_CACHE', 'from cache');

/**
 * Implements hook_menu()
 */

function ceenclient_menu() {
  $items = array();
  
  $items['ajax/ceenclient/credential_status'] = array(
    'title'             => 'CEERN Credentials AJAX check',
    'description'       => 'Access callback to check if credentials are good for CEEN.',
    'access arguments'  => array('administer site configuration'),
    'page callback' => 'ceenclient_credential_status_ajax',
    'type' => MENU_CALLBACK,
  );
  
  $items['admin/settings/ceen'] = array(
    'title'             => 'CEERN Credentials',
    'description'       => 'CEEN settings.',
    'access arguments'  => array('administer site configuration'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ceenclient_admin_settings'),
  );
      
  return $items;
}

/**
 * Loads mapper info from various modules.
 */

function ceenclient_load_mapper_info() {
  $mappers = array();
  foreach (module_implements('ceen_mapping') as $module) {
    $function = $module . '_ceen_mapping';
    $data = $function();
    
    foreach ($data as $key => $value) {
      $mappers[$key] = $value;
    }
  }
  
  return $mappers;
}

/**
 * Implements hook_ceen_mapping().
 */
 
function ceenclient_ceen_mapping() {
  return array(
    'CeenIncomingDefault' => array(
      'name' => 'Default',
      'file' => 'IncomingDefault.inc',
      'path' => drupal_get_path('module', 'ceenclient') . '/includes',
      'direction' => CEEN_MAPPING_INCOMING,
    ),
    'CeenOutgoingDefault' => array(
      'name' => 'Default',
      'file' => 'OutgoingDefault.inc',
      'path' => drupal_get_path('module', 'ceenclient') . '/includes',
      'direction' => CEEN_MAPPING_OUTGOING,
    ),
  );
}

/**
 * Implements hook_menu_alter().
 */
 
function ceenclient_menu_alter(&$form) {
  $node_types = array_keys(node_get_types('types'));
  
  foreach ($node_types as $node_type) {
    $items['admin/content/node-type/' . $node_type]['type'] = MENU_DEFAULT_LOCAL_TASK;
  }
}

/**
 * Implements hook_flush_caches().
 */

function ceenclient_flush_caches() {
  return array('cache_ceenclient');
}

/**
 * Submit handler for mapping form.
 */
 
function ceenclient_mapping_form_submit($form, &$form_state) {
  drupal_set_message('Mapping settings saved.');
}

/**
 * Page callback for admin.
 */

function ceenclient_admin_settings() {
  $form = array();
  
  $form['ceenclient_service_url'] = array(
    '#type' => (isset($_GET['devel'])) ? 'textfield' : 'value', // only want to display this if it's for development.
    '#title' => t('CEEN Service URL'),
    '#default_value' => variable_get('ceenclient_service_url', 'http://api.resourcecommons.org/services/rest'),
  );
  
  $form['ceenclient_service_public_key'] = array(
    '#type' => 'textfield',
    '#title' => t('CEEN Public Key'),
    '#default_value' => variable_get('ceenclient_service_public_key', ''),
  );
  
  $form['ceenclient_service_private_key'] = array(
    '#type' => 'textfield',
    '#title' => t('CEEN Private Key'),
    '#default_value' => variable_get('ceenclient_service_private_key', ''),
  );
  
  $me = ceenclient_resource_call(variable_get('ceenclient_service_url', 'http://api.resourcecommons.org/services/rest') . '/source/me');
  
  if (!empty($me)) {
    $table_data = array(
      array('Name', $me['name']),
      array('Server ID', $me['uuid']),
    );
    
    $form['ceenclient_data'] = array(
      '#type' => 'markup',
      '#value' => '<h4>' . t('CEERN Information') . '</h4>' . theme('table', array(), $table_data),
    );  
  }
  
  return system_settings_form($form);
}

/**
 * Page callback for credential check on admin screen.
 * @TODO: Make a call to the api, check to see if public/private keys are valid.
 */

function ceenclient_credential_status_ajax() {
  drupal_json('test');
}

/**
 * Implementation of hook_user().
 */
 
function ceenclient_user($op, &$edit, &$account, $category = NULL) {
  switch ($op) {
    case 'load':
      $account->ceen_uuid = db_result(db_query('SELECT uuid FROM {ceenapi_to_object} WHERE oid = %d AND object = "user"', $account->uid));
      break;
    case 'insert':
    case 'update':
    
      break;
    case 'delete':
    
      break;
  }
}

/**
 * Implementation of hook_nodeapi().
 */

function ceenclient_nodeapi(&$node, $op, $a3 = NULL, $a4 = NULL) {
  if (variable_get('ceen_save_to_api_' . $node->type, FALSE)) {
    $is_new = FALSE;
    switch ($op) {
      case 'load':
        $node->ceen_uuid = db_result(db_query('SELECT uuid FROM {ceenapi_to_object} WHERE oid = %d && object = "node"', $node->nid));
        break;
      case 'insert':
        $is_new = TRUE;
        // intentional dropthrough.
      case 'update':
        if (!isset($node->ceen_from_api)) {
          // Include mapping classes.
          $map_class = variable_get('ceenclient_outgoing_' . $node->type, '');
          if ($map_class != '') {
            // include base file first.
            include_once('./' . drupal_get_path('module', 'ceenclient') . '/includes/CeenProcess.inc');
            $mappers = ceenclient_load_mapper_info();
            include_once('./' . $mappers[$map_class]['path'] . '/' . $mappers[$map_class]['file']);
            
            $mapper = new $map_class();
            $resource = array();
            
            $mapper->process($node, $resource);
            
            $resource_call_type = 'PUT';
            if ($is_new) {
              $resource_call_type = 'POST';
            }
            
            ceenclient_resource_call(variable_get('ceenclient_service_url', '') . '/resource', $resource, $resource_call_type);          
          }
        }
        break;
      case 'delete':
        if (!isset($node->ceen_from_api)) {
          ceenclient_resource_call(variable_get('ceenclient_service_url', '') . '/resource/' . $node->ceen_uuid, array(), 'DELETE');
          db_query_range('DELETE FROM {ceenapi_to_object} WHERE oid = %d && object = "node"', 0, 1, $node->nid);
        }
        break;
    }
  }
}

/**
* Implementation of hook_views_api().
* @return Array with Views API version.
*/
function ceenclient_views_api() {
  return array('api' => 2.0);
}

/**
 * Implementation of hook_form_alter().
 *
 * - Handles adjustment to node type form for ConEd integration.
 * - Handles adjustment to user form for ConEd integration.
 */
function ceenclient_form_alter(&$form, $form_state, $form_id) {
  if ($form_id == 'node_type_form' && isset($form['identity']['type'])) {
    // Content type form.
    $form['ceen'] = array(
      '#type' => 'fieldset',
      '#title' => 'ConEd API Integration',
    ); 
    
    $form['ceen']['ceen_save_to_api'] = array(
      '#type' => 'checkbox',
      '#title' => t('Sync with API?'),
      '#description' => 'Should this content type be synced with the general API?',
      '#default_value' => variable_get('ceen_save_to_api_' . $form['#node_type']->type, 0),
    );
    
    $form['ceen']['ceen_additional_parameters'] = array(
      '#type' => 'textfield',
      '#title' => t('Additional Parameters'),
      '#description' => 'Additional Search parameters. Used to filter out resources.',
      '#default_value' => variable_get('ceen_additional_parameters_' . $form['#node_type']->type, ''),
    );
    
    $incoming_options = $outgoing_options = array(
      '' => '<none>',
    );
    
    $mappers = ceenclient_load_mapper_info();
    
    foreach ($mappers as $key => $map) {
      if ($map['direction'] == CEEN_MAPPING_INCOMING) {
        $incoming_options[$key] = $map['name'];      
      } 
      elseif ($map['direction'] == CEEN_MAPPING_OUTGOING) {
        $outgoing_options[$key] = $map['name'];
      }
    }
    
    $form['ceen']['ceenclient_incoming'] = array(
      '#type' => 'select',
      '#title' => t('Incoming'),
      '#options' => $incoming_options,
      '#default_value' => variable_get('ceenclient_incoming_' . $form['#node_type']->type, 'CeenIncomingDefault'),
    );
    
    $form['ceen']['ceenclient_outgoing'] = array(
      '#type' => 'select',
      '#title' => t('Outgoing'),
      '#options' => $outgoing_options,
      '#default_value' => variable_get('ceenclient_outgoing_' . $form['#node_type']->type, 'CeenOutgoingDefault'),
    );
  }
  elseif (preg_match('/_node_form$/', $form_id)) {
    if (variable_get('ceen_save_to_api_'. $form['#node']->type, FALSE)) {
      /**
       * @TODO: Do we want to handle resource types as a custom field on our own, or just rely on CCK?
       */
    }
  }
}

/**
 * Requests data from CEEN. Adds authentication automatically.
 *
 * @param $uri
 *   URI of request. http://example.com/services/rest/resource/1
 * @param $params
 *   Keyed array of parameters to add to uri.
 *
 * @return
 *   A data object from CEEN.
 */

function ceenclient_resource_call($uri, $params = array(), $method = 'GET') {
  static $ceenclient_api_calls;
  
  $key = $uri . '?' . drupal_query_string_encode($params);
  
  // Check for cache first.
  if ($method == 'GET') {
    if (isset($ceenclient_api_calls[$key])) {
      module_invoke_all('ceen_resource_call', $uri, $params, $method, $ceenclient_api_calls[$key], CEENCLIENT_FROM_CACHE);
      return $ceenclient_api_calls[$key];
    }
    
    if ($data = cache_get($key, 'cache_ceenclient')) {
      module_invoke_all('ceen_resource_call', $uri, $params, $method, $data->data, CEENCLIENT_FROM_CACHE);
      return $data->data;
    }
  }
  
  $public_key = variable_get('ceenclient_service_public_key', '');
  $private_key = variable_get('ceenclient_service_private_key', '');
  $nonce = uniqid(mt_rand());
  $timestamp = time();
  
  $hash_parameters = array($timestamp, $public_key, $nonce);
  $hash = hash_hmac("sha256", implode(';', $hash_parameters), $private_key);
  
  $url_args = array();
  $data = NULL;
  
  if (strtoupper($method) == 'GET') {
    $url_args += $params;
  } 
  else {
    $data = serialize($params);
  }
  
  $url_args['hash'] = $hash;
  $url_args['timestamp'] = $timestamp;
  $url_args['public_key'] = $public_key;
  $url_args['nonce'] = $nonce;
  
  $headers = array(
    'Content-Type' => 'application/vnd.php.serialized',
    'Accept' => 'application/vnd.php.serialized',
  );

  // Automatically add .php to end of uri to ensure data comes back in expected format.
  $request = drupal_http_request($uri . '.php?' . drupal_query_string_encode($url_args), $headers, strtoupper($method), $data);
  
  $return_data = unserialize($request->data);
  
  // save to our caches.
  if ($method == 'GET') {
    $ceenclient_api_calls[$key] = $return_data;
    cache_set($key, $return_data, 'cache_ceenclient', CACHE_TEMPORARY);
  }
  
  module_invoke_all('ceen_resource_call', $uri, $params, $method, $return_data, CEENCLIENT_FROM_API);
  
  return $return_data;
}

/**
 * Implementation of hook_cron().
 */
 
function ceenclient_cron() {
   ceenclient_load_updates();
}

/**
 * Takes a user, saves it to API.
 *
 * @param $account
 *   User account object.
 */
 
function ceenclient_save_user($account) {
  /**
   * @TODO: Use Content Profile for extra data about our users.
   */
  $api_user_object = array(
    'first_name' => $account->name,
    'last_name' => " ",
    'contact' => array(
      'mail' => $account->mail,
    ), 
  );
  
  $resource_url = '/user';
  $resource_call_type = 'POST';
    
  if ($account->ceen_uuid) {
    $resource_url .= "/" . $account->ceen_uuid;
    $resource_call_type = 'PUT';
  }
  
  $return = ceenclient_resource_call(variable_get('ceenclient_service_url', '') . $resource_url, $api_user_object, $resource_call_type);
  
  if (!$return) {
    drupal_set_message(t("Error saving user to CEERN API"), 'error');
  } 
  else {
    $update = array();
  
    $ceen_data = array('oid' => $account->uid, 'object' => 'user', 'uuid' => $return->uuid);
  
    if ($account->ceen_uuid != NULL) {
      $update = 'oid';
      unset($ceen_data['oid']);
    }
    
    drupal_write_record('ceenapi_to_object', $ceen_data, $update);
  }
}

/**
 * Generic function for loading sets of resources from API.
 *
 * To be used primarily with hook_cron(), but could potentially use elsewhere. Action? Page callback to load manually?
 */
 
function ceenclient_load_updates() {
  /**
   * Pseudo: 
   * - Load list of content types that need to be synced with api. 
   * - Load a value that represents last updated time.
   * - Grab data list from API for each content type.
   * - Run through list. Add/update/delete items as necessary.
   */
  
  $max_count = variable_get('ceenclient_api_max_batch_count', 50);
  
  $node_types = node_get_types('types');
  
  foreach ($node_types as $node_type) {
    if (variable_get('ceen_save_to_api_' . $node_type->type, 0) == 1) {
      // Include mapping classes.
      $map_class = variable_get('ceenclient_incoming_' . $node_type->type, '');
      
      if (!empty($map_class)) {      
        // include base file first.
        include_once('./' . drupal_get_path('module', 'ceenclient') . '/includes/CeenProcess.inc');
        $mappers = ceenclient_load_mapper_info();
        include_once('./' . $mappers[$map_class]['path'] . '/' . $mappers[$map_class]['file']);
        
        $mapper = new $map_class();
      
        $last_update = variable_get('ceenclient_api_last_update_' . $node_type->type, 0);
        $additional_parameters_string = variable_get('ceen_additional_parameters_' . $node_type->type, '');
        
        $additional_parameters_components = explode('&', $additional_parameters_string);
        $additional_parameters = array();
        
        foreach ($additional_parameters_components as $component) {
          $component_parts = explode('=', $component);
          $additional_parameters[$component_parts[0]] = $component_parts[1];
        }
        
        $default_parameters = array(
          'status' => 1, 
          'sort' => 'update', 
          'update' => $last_update,
        );
        
        $parameters = array_merge($default_parameters, $additional_parameters);
              
        $data = ceenclient_resource_call(variable_get('ceenclient_service_url', '') . '/resource', $parameters);
              
        foreach ($data['resources'] as $resource) {
          $resource_data = ceenclient_resource_call($resource['uri']);
          
          $is_new = FALSE;
          $node = new stdClass();
          
          switch ($resource['status']) {
            case 'PUBLISHED':
              $node->type = $node_type->type;
              module_load_include('inc', 'node', 'node.pages');
              node_object_prepare($node);
                          
              $is_new = TRUE;
              
            // Intentional dropthrough.
            case 'UPDATED':
              if (!$is_new) {
                $node = ceenclient_node_load_uuid($resource['uuid']);
              }
              
              $mapper->process($resource_data, $node);
              $node->ceen_from_api = TRUE; // To keep an endless loop from happening in hook_api.
              node_save($node);
              
              if ($is_new) {
                db_query('INSERT INTO {ceenapi_to_object} (oid, object, uuid) VALUES (%d, "node", "%s")', $node->nid, $resource_data['uuid']);
              }
                          
              variable_set('ceenclient_api_last_update_' . $node_type->type, $resource['last_updated']);
              break;
            case 'DELETED':
              $node = ceenclient_node_load_uuid($resource['uuid']);
              node_delete($node->nid);
              variable_set('ceenclient_api_last_update_' . $node_type->type, $resource['last_updated']);
              break;
          }
        }      
      }
    }
  }
}

/**
 * Retrieves ceern uuid for a user. If nothing's passed in, default to current user.
 */
 
function ceenclient_user_uuid($uid = -1) {
  global $user;
  
  if ($uid < 0) {
    $uid = $user->uid;
  }
  
  return db_result(db_query('SELECT uuid FROM {ceenapi_to_object} WHERE oid = %d AND object = "user"', $uid));
}

/**
 * Retrieves node based on uuid.
 */
 
function ceenclient_node_load_uuid($uuid) {
  $nid = db_result(db_query('SELECT oid FROM {ceenapi_to_object} WHERE uuid = "%s" AND object = "node"', $uuid));
  return node_load($nid);
}